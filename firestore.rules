
/**
 * This Firestore Security Ruleset is designed for the DCAM Classes application.
 *
 * Core Philosophy:
 * The security model is based on a clear separation between public, read-only educational
 * content and private, user-specific data. It enforces a role-based access control (RBAC)
 * system, granting elevated write permissions to 'teacher' and 'admin' users for managing shared
 * learning materials and user roles. User data is strictly segregated and owned by the user.
 *
 * Data Structure:
 * - /users/{userId}: Private user profile data.
 * - /roles_admin/{userId}: A lookup collection to identify users with the 'admin' role.
 * - /roles_teacher/{userId}: A lookup collection to identify users with the 'teacher' role.
 * - Top-level collections (e.g., /content, /topics, /live_classes): Shared educational
 *   materials accessible to all authenticated users.
 *
 * Key Security Decisions:
 * - Default Deny: All paths are closed by default. Access is granted explicitly.
 * - User Privacy: Users can only access their own data within their `/users/{userId}` document tree.
 *   Admins and teachers have limited, role-specific read access to user profiles.
 * - Role-Based Management: Only users marked as 'admin' can manage the curriculum and user roles.
 *   Teachers can manage content, live classes, and practice questions.
 * - Public Content Accessibility: All signed-in users (students and teachers) can read shared
 *   educational content to facilitate learning.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --------------------------------------------------------------------
    // Helper Functions
    // --------------------------------------------------------------------

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the currently authenticated user's UID matches the provided userId.
     * Used to verify ownership of a resource.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * Checks for ownership on an existing document.
     * Prevents modifying or deleting documents that do not exist.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * Checks if the authenticated user has a 'teacher' role.
     * This is determined by the existence of a document in the /roles_teacher collection.
     * This is a performant check that costs one read operation.
     */
    function isTeacher() {
      return exists(/databases/$(database)/documents/roles_teacher/$(request.auth.uid));
    }

    /**
     * Checks if the authenticated user has an 'admin' role.
     * This is determined by the existence of a document in the /roles_admin collection.
     */
    function isAdmin() {
      return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }
    
    /**
     * Checks if the authenticated user has an active subscription.
     * This relies on a denormalized 'subscriptionStatus' field on the user's profile document.
     */
    function isSubscribed() {
      let userDoc = get(/databases/$(database)/documents/users/$(request.auth.uid));
      return userDoc != null 
             && 'subscriptionStatus' in userDoc.data 
             && (userDoc.data.subscriptionStatus == 'active' || userDoc.data.subscriptionStatus == 'trialing');
    }

    // --------------------------------------------------------------------
    // User Data Rules
    // --------------------------------------------------------------------

    /**
     * @description Manages user profile data. A user can create their own profile
     *              and can read, update, or delete their own data subsequently.
     *              Teachers and Admins have role-specific access.
     * @path        /users/{userId}
     * @principle   Enforces strict data ownership and privacy, with elevated privileges for admins.
     */
    match /users/{userId} {
      allow get: if isOwner(userId) || isTeacher() || isAdmin();
      allow list: if isSignedIn();
      allow create: if isOwner(userId) && request.resource.data.id == userId && !exists(/databases/$(database)/documents/blocked_emails/$(request.resource.data.email));
      // Admins can manage roles and subscriptions. Teachers can manage subscriptions. Users can update their own profile.
      // The special admin email can update their own role for bootstrapping.
      allow update: if (isOwner(userId) && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['firstName', 'lastName', 'photoURL'])) ||
                       (isTeacher() && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['subscriptionStatus', 'subscriptionPlanId'])) ||
                       (isAdmin() && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['roleId', 'subscriptionStatus', 'subscriptionPlanId', 'teacherStatus'])) ||
                       (isOwner(userId) && request.auth.token.email == 'dcamclassesiit@gmail.com' && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['roleId']));
      allow delete: if isExistingOwner(userId) || isAdmin();
      
       /**
       * @description Manages a user's subscription data. Only the user can read their
       *              own subscription status. Teachers/Admins can manage subscriptions.
       * @path        /users/{userId}/subscriptions/{subscriptionId}
       */
      match /subscriptions/{subscriptionId} {
        allow get, list: if isOwner(userId) || isTeacher() || isAdmin();
        allow create, update, delete: if isTeacher() || isAdmin();
      }
      
      /**
       * @description Stores results for mock tests taken by the user.
       * @path        /users/{userId}/test_results/{resultId}
       */
      match /test_results/{resultId} {
        allow get, list, create: if isOwner(userId);
        allow update, delete: if false;
      }

      /**
       * @description Stores results for practice sessions taken by the user.
       * @path        /users/{userId}/practice_results/{resultId}
       */
      match /practice_results/{resultId} {
        allow get, list, create: if isOwner(userId);
        allow update, delete: if false;
      }

      /**
       * @description Stores custom mock tests created by the user.
       * @path        /users/{userId}/custom_tests/{testId}
       */
      match /custom_tests/{testId} {
        allow read, write: if isOwner(userId);
      }
    }
    
    // --------------------------------------------------------------------
    // Role & System Configuration Rules
    // --------------------------------------------------------------------

    /**
     * @description System-defined roles (e.g., student, teacher).
     *              These are read-only for all clients and managed server-side.
     * @path        /roles/{roleId}
     */
    match /roles/{roleId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if false;
    }

    /**
     * @description A lookup collection to identify admins. Existence of a document
     *              confers admin privileges. Only other admins can manage this.
     * @path        /roles_admin/{userId}
     */
    match /roles_admin/{userId} {
      allow get, list: if isSignedIn();
      // Allow self-creation for bootstrapping the first admin.
      allow create: if isOwner(userId) || isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @description A lookup collection to identify teachers. Existence of a document
     *              confers teacher privileges. Admins can manage this.
     * @path        /roles_teacher/{userId}
     */
    match /roles_teacher/{userId} {
      allow get, list: if isSignedIn();
      allow create: if isOwner(userId) || isAdmin();
      allow update: if false;
      allow delete: if isAdmin();
    }
    
    /**
     * @description Stores emails of users who are blocked from creating new accounts.
     *              Only manageable by admins.
     * @path        /blocked_emails/{email}
     */
    match /blocked_emails/{email} {
      allow read, write: if isAdmin();
    }

    // --------------------------------------------------------------------
    // Public Content Rules (Managed by Roles)
    // --------------------------------------------------------------------
    
    /**
     * @description Exam Type definitions. Readable by anyone signed in, manageable by admins.
     * @path        /exam_types/{examTypeId}
     */
    match /exam_types/{examTypeId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isAdmin();
    }
    
    /**
     * @description Class definitions. Readable by anyone signed in, manageable by admins.
     * @path        /classes/{classId}
     */
    match /classes/{classId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isAdmin();
    }

    /**
     * @description Learning content. Readable by any signed-in user, manageable by teachers.
     * @path        /content/{contentId}
     */
    match /content/{contentId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isTeacher();
    }

    /**
     * @description Curriculum topics. Readable by anyone signed in, manageable by admins.
     * @path        /topics/{topicId}
     */
    match /topics/{topicId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isAdmin();
    }
    
    /**
     * @description Subject definitions. Readable by anyone signed in, manageable by admins.
     * @path        /subjects/{subjectId}
     */
    match /subjects/{subjectId} {
        allow get, list: if isSignedIn();
        allow create, update, delete: if isAdmin();
    }

    /**
     * @description Practice questions. Readable by any signed-in user, manageable by teachers.
     * @path        /practice_questions/{practiceQuestionId}
     */
    match /practice_questions/{practiceQuestionId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isTeacher();
    }

    /**
     * @description Mock tests. Readable by anyone signed in, manageable by teachers.
     * @path        /mock_tests/{mockTestId}
     */
    match /mock_tests/{mockTestId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isTeacher();
    }

    // --------------------------------------------------------------------
    // Interactive Content Rules (Mixed Ownership)
    // --------------------------------------------------------------------

    /**
     * @description Live classes scheduled by teachers. Anyone can view the schedule.
     *              Only the teacher who created the class can manage it.
     * @path        /live_classes/{liveClassId}
     */
    match /live_classes/{liveClassId} {
      allow get, list: if isSignedIn();
      allow create: if isTeacher() && request.resource.data.teacherId == request.auth.uid;
      allow update: if resource != null && isOwner(resource.data.teacherId);
      allow delete: if resource != null && isOwner(resource.data.teacherId);
    }
    
    // --------------------------------------------------------------------
    // Doubt Resolution Rules
    // --------------------------------------------------------------------
    /**
     * @description Manages student doubts. Students create, teachers answer.
     * @path        /doubts/{doubtId}
     */
    match /doubts/{doubtId} {
      allow get, list: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.studentId == request.auth.uid;
      allow update: if resource != null && (isOwner(resource.data.studentId) || isTeacher());
      allow delete: if resource != null && isOwner(resource.data.studentId);
    }
    
    // --------------------------------------------------------------------
    // Chat Rules
    // --------------------------------------------------------------------
    /**
     * @description Public group chat messages.
     * @path        /group_chat_messages/{messageId}
     */
    match /group_chat_messages/{messageId} {
      allow read, list: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.senderId == request.auth.uid;
      allow update, delete: if false;
    }

    /**
     * @description Private 1-on-1 chat messages.
     * @path        /direct_messages/{chatId}/messages/{messageId}
     */
    match /direct_messages/{chatId}/messages/{messageId} {
      allow list, get: if isSignedIn() && request.auth.uid in chatId.split('_');
      allow create: if isSignedIn() && request.auth.uid in chatId.split('_') && request.resource.data.senderId == request.auth.uid;
      allow update, delete: if false;
    }

    // --------------------------------------------------------------------
    // Subscription & Billing Rules
    // --------------------------------------------------------------------
    
    /**
     * @description Defines the available subscription plans. Readable by all, writable by teachers/admins.
     * @path        /subscription_plans/{planId}
     */
    match /subscription_plans/{planId} {
        allow get, list: if isSignedIn();
        allow create, update, delete: if isTeacher() || isAdmin();
    }
    
    // --------------------------------------------------------------------
    // Notification Rules
    // --------------------------------------------------------------------
    /**
     * @description Global notifications. Readable by all, writable only by teachers/admins.
     * @path        /notifications/{notificationId}
     */
    match /notifications/{notificationId} {
      allow read, list: if isSignedIn();
      allow create: if isTeacher() || isAdmin();
      allow update, delete: if false;
    }

    // --------------------------------------------------------------------
    // Analytics Rules
    // --------------------------------------------------------------------
    /**
     * @description Aggregated analytics for mock tests.
     * @path        /test_analytics/{testId}
     */
    match /test_analytics/{testId} {
      allow read: if isSignedIn();
      allow write: if isSignedIn();
    }

    // --------------------------------------------------------------------
    // Dashboard Configuration Rules
    // --------------------------------------------------------------------
    /**
     * @description Stores dashboard quick links. Manageable by teachers/admins.
     * @path        /dashboard_links/{linkId}
     */
    match /dashboard_links/{linkId} {
      allow read: if isSignedIn();
      allow create, update, delete: if isTeacher() || isAdmin();
    }
  }
}
