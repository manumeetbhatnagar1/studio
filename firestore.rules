/**
 * This Firestore Security Ruleset is designed for the DCAM Classes application.
 *
 * Core Philosophy:
 * The security model is based on a clear separation between public, read-only educational
 * content and private, user-specific data. It enforces a role-based access control (RBAC)
 * system, granting elevated write permissions to 'teacher' and 'admin' users for managing shared
 * learning materials and user roles. User data is strictly segregated and owned by the user.
 *
 * Data Structure:
 * - /users/{userId}: Private user profile data.
 * - /roles_admin/{userId}: A lookup collection to identify users with the 'admin' role.
 * - /roles_teacher/{userId}: A lookup collection to identify users with the 'teacher' role.
 * - Top-level collections (e.g., /content, /topics, /live_classes): Shared educational
 *   materials accessible to all authenticated users.
 *
 * Key Security Decisions:
 * - Default Deny: All paths are closed by default. Access is granted explicitly.
 * - User Privacy: Users can only access their own data within their `/users/{userId}` document tree.
 *   Admins and teachers have limited, role-specific read access to user profiles.
 * - Role-Based Management: Only users marked as 'admin' can manage the curriculum and user roles.
 *   Teachers can manage content, live classes, and practice questions.
 * - Public Content Accessibility: All signed-in users (students and teachers) can read shared
 *   educational content to facilitate learning.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --------------------------------------------------------------------
    // Helper Functions
    // --------------------------------------------------------------------

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the currently authenticated user's UID matches the provided userId.
     * Used to verify ownership of a resource.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * Checks for ownership on an existing document.
     * Prevents modifying or deleting documents that do not exist.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * Checks if the authenticated user has a 'teacher' role.
     * This is determined by the existence of a document in the /roles_teacher collection.
     * This is a performant check that costs one read operation.
     */
    function isTeacherByProfile() {
      let userDoc = get(/databases/$(database)/documents/users/$(request.auth.uid));
      return isSignedIn()
             && userDoc != null
             && 'roleId' in userDoc.data
             && (userDoc.data.roleId == 'teacher' || userDoc.data.roleId == 'admin');
    }

    function isTeacher() {
      return isSignedIn()
             && (
               exists(/databases/$(database)/documents/roles_teacher/$(request.auth.uid))
               || isTeacherByProfile()
             );
    }

    /**
     * Checks if the authenticated user is an approved teacher.
     * Reads the user's profile doc for teacherStatus.
     */
    function isApprovedTeacher() {
      let userDoc = get(/databases/$(database)/documents/users/$(request.auth.uid));
      return isTeacher()
             && userDoc != null
             && 'teacherStatus' in userDoc.data
             && userDoc.data.teacherStatus == 'approved';
    }

    /**
     * Checks if the authenticated user has an 'admin' role.
     * This is determined by the existence of a document in the /roles_admin collection.
     */
    function isAdmin() {
      return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    /**
     * Checks if a teacher sender is messaging an admin in a 1:1 chat.
     */
    function isTeacherMessagingAdmin(chatId) {
      let participants = chatId.split('_');
      return participants.size() == 2
             && request.auth.uid in participants
             && (
               (participants[0] == request.auth.uid
                && exists(/databases/$(database)/documents/roles_admin/$(participants[1])))
               || (participants[1] == request.auth.uid
                   && exists(/databases/$(database)/documents/roles_admin/$(participants[0])))
             );
    }
    
    /**
     * Checks if the authenticated user is the designated super admin.
     * This provides a bootstrap mechanism for the first admin account.
     */
    function isDesignatedAdmin() {
      return request.auth.token.email == 'manumeet.bhatnagar1@gmail.com';
    }
    
    /**
     * Checks if the authenticated user has an active subscription.
     * This relies on a denormalized 'subscriptionStatus' field on the user's profile document.
     */
    function isSubscribed() {
      let userDoc = get(/databases/$(database)/documents/users/$(request.auth.uid));
      return userDoc != null 
             && 'subscriptionStatus' in userDoc.data 
             && (userDoc.data.subscriptionStatus == 'active' || userDoc.data.subscriptionStatus == 'trialing');
    }

    // --------------------------------------------------------------------
    // User Data Rules
    // --------------------------------------------------------------------

    /**
     * @description Manages user profile data. A user can create their own profile
     *              and can read, update, or delete their own data subsequently.
     *              Teachers and Admins have role-specific access.
     * @path        /users/{userId}
     * @principle   Enforces strict data ownership and privacy, with elevated privileges for admins.
     */
    match /users/{userId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isOwner(userId) && request.resource.data.id == userId && !exists(/databases/$(database)/documents/blocked_emails/$(request.resource.data.email));
      
      allow update: if
        // Admins can update any user profile.
        isAdmin() ||
        // Designated admin can update their own profile, including their role.
        (isDesignatedAdmin() && isOwner(userId)) ||
        // A teacher can update subscription fields for any user.
        (isTeacher() && request.writeFields.hasOnly(['subscriptionStatus', 'subscriptionPlanId'])) ||
        // A user can update their own profile, but cannot change their roleId or teacherStatus.
        (isOwner(userId) &&
          (!('roleId' in request.resource.data) || request.resource.data.roleId == resource.data.roleId) &&
          (!('teacherStatus' in request.resource.data) || request.resource.data.teacherStatus == resource.data.teacherStatus)
        );

      allow delete: if isExistingOwner(userId) || isAdmin();
      
       /**
       * @description Manages a user's subscription data. Only the user can read their
       *              own subscription status. Teachers/Admins can manage subscriptions.
       * @path        /users/{userId}/subscriptions/{subscriptionId}
       */
      match /subscriptions/{subscriptionId} {
        allow read, write: if isOwner(userId) || isTeacher() || isAdmin();
      }
      
      /**
       * @description Stores results for mock tests taken by the user.
       * @path        /users/{userId}/test_results/{resultId}
       */
      match /test_results/{resultId} {
        allow get, list: if isOwner(userId) || isAdmin();
        allow create: if isOwner(userId);
        allow update: if false;
        allow delete: if isAdmin();
      }

      /**
       * @description Stores results for practice sessions taken by the user.
       * @path        /users/{userId}/practice_results/{resultId}
       */
      match /practice_results/{resultId} {
        allow get, list: if isOwner(userId) || isAdmin();
        allow create: if isOwner(userId);
        allow update: if false;
        allow delete: if isAdmin();
      }

      /**
       * @description Stores per-course learning progress for a user.
       * @path        /users/{userId}/course_progress/{courseId}
       */
      match /course_progress/{courseId} {
        allow get, list: if isOwner(userId) || isAdmin();
        allow create, update: if isOwner(userId);
        allow delete: if isAdmin();
      }

      /**
       * @description Stores custom mock tests created by the user.
       * @path        /users/{userId}/custom_tests/{testId}
       */
      match /custom_tests/{testId} {
        allow get, list: if isOwner(userId) || isAdmin();
        allow create, update, delete: if isOwner(userId) || isAdmin();
      }

      /**
       * @description Stores user enrollments for live batches.
       * @path        /users/{userId}/enrolled_live_batches/{batchId}
       */
      match /enrolled_live_batches/{batchId} {
        allow get, list: if isOwner(userId)
                         || isAdmin()
                         || (
                           isTeacher()
                           && exists(/databases/$(database)/documents/live_batches/$(batchId))
                           && get(/databases/$(database)/documents/live_batches/$(batchId)).data.teacherId == request.auth.uid
                         );
        allow create, update: if (isOwner(userId) || isAdmin())
                              && request.resource.data.batchId == batchId
                              && exists(/databases/$(database)/documents/live_batches/$(batchId))
                              && (
                                !('publicationStatus' in get(/databases/$(database)/documents/live_batches/$(batchId)).data)
                                || get(/databases/$(database)/documents/live_batches/$(batchId)).data.publicationStatus == 'published'
                              );
        allow delete: if isOwner(userId) || isAdmin();
      }

      /**
       * @description Attempt history for self-created custom mock tests.
       * @path        /users/{userId}/custom_tests/{testId}/attempts/{attemptId}
       */
      match /custom_tests/{testId}/attempts/{attemptId} {
        allow get, list, create: if isOwner(userId) || isAdmin();
        allow update: if false;
        allow delete: if isAdmin();
      }

      /**
       * @description Per-user chat preferences (e.g., group chat clear timestamp).
       * @path        /users/{userId}/chat_preferences/{prefId}
       */
      match /chat_preferences/{prefId} {
        allow read, write: if isOwner(userId) || isTeacher() || isAdmin();
      }

      /**
       * @description Teacher-facing sales ledger for purchases linked to their content.
       * @path        /users/{userId}/sales/{saleId}
       */
      match /sales/{saleId} {
        allow get, list: if isOwner(userId) || isAdmin();
        allow create: if isSignedIn()
                      && request.resource.data.teacherId == userId
                      && (
                        request.resource.data.studentId == request.auth.uid
                        || isAdmin()
                      );
        allow update: if false;
        allow delete: if isAdmin();
      }

      /**
       * @description Student-owned purchased courses ledger.
       * @path        /users/{userId}/purchased_courses/{courseId}
       */
      match /purchased_courses/{courseId} {
        allow get, list: if isOwner(userId) || isAdmin();
        allow create, update: if isOwner(userId) || isAdmin();
        allow delete: if isOwner(userId) || isAdmin();
      }

      /**
       * @description Student-owned purchased mock tests ledger.
       * @path        /users/{userId}/purchased_mock_tests/{testId}
       */
      match /purchased_mock_tests/{testId} {
        allow get, list: if isOwner(userId) || isAdmin();
        allow create, update: if isOwner(userId) || isAdmin();
        allow delete: if isOwner(userId) || isAdmin();
      }

      /**
       * @description Student-owned purchased live batches ledger.
       * @path        /users/{userId}/purchased_live_batches/{batchId}
       */
      match /purchased_live_batches/{batchId} {
        allow get, list: if isOwner(userId) || isAdmin();
        allow create, update: if isOwner(userId) || isAdmin();
        allow delete: if isOwner(userId) || isAdmin();
      }

      /**
       * @description Premium mock feature purchases by exam/curriculum combination per teacher.
       * @path        /users/{userId}/premium_mock_feature_purchases/{purchaseId}
       */
      match /premium_mock_feature_purchases/{purchaseId} {
        allow get, list: if isOwner(userId) || isAdmin();
        allow create, update: if isOwner(userId) || isAdmin();
        allow delete: if isOwner(userId) || isAdmin();
      }

      /**
       * @description Premium practice session purchases per student.
       * @path        /users/{userId}/premium_practice_session_purchases/{purchaseId}
       */
      match /premium_practice_session_purchases/{purchaseId} {
        allow get, list: if isOwner(userId) || isAdmin();
        allow create, update: if isOwner(userId) || isAdmin();
        allow delete: if isOwner(userId) || isAdmin();
      }
    }

    // Explicit fallback removed: handled within /users/{userId} scope above.
    
    // --------------------------------------------------------------------
    // Role & System Configuration Rules
    // --------------------------------------------------------------------

    /**
     * @description System-defined roles (e.g., student, teacher).
     *              These are read-only for all clients and managed server-side.
     * @path        /roles/{roleId}
     */
    match /roles/{roleId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if false;
    }

    /**
     * @description A lookup collection to identify admins. Existence of a document
     *              confers admin privileges. Admins can manage this collection.
     * @path        /roles_admin/{userId}
     */
     match /roles_admin/{userId} {
        allow get: if isSignedIn();
        allow list: if false;
        allow write: if isAdmin() || (isDesignatedAdmin() && isOwner(userId));
    }

    /**
     * @description A lookup collection to identify teachers. Existence of a document
     *              confers teacher privileges. Admins can manage this.
     * @path        /roles_teacher/{userId}
     */
    match /roles_teacher/{userId} {
        allow get: if isSignedIn();
        allow list: if false;
        allow create: if isAdmin() || isOwner(userId) || (isDesignatedAdmin() && isOwner(userId));
        allow update, delete: if isAdmin() || (isDesignatedAdmin() && isOwner(userId));
    }
    
    /**
     * @description Stores emails of users who are blocked from creating new accounts.
     *              Only manageable by admins.
     * @path        /blocked_emails/{email}
     */
    match /blocked_emails/{email} {
      allow read, write: if isAdmin();
    }

    /**
     * @description Global platform settings such as revenue percentages.
     * @path        /platform_settings/{settingId}
     */
    match /platform_settings/{settingId} {
      allow get: if isSignedIn();
      allow list: if false;
      allow create, update, delete: if isAdmin();
    }

    /**
     * @description Teacher-specific commission overrides.
     * @path        /teacher_commission_overrides/{teacherId}
     */
    match /teacher_commission_overrides/{teacherId} {
      allow get: if isSignedIn();
      allow list: if isAdmin();
      allow create, update, delete: if isAdmin();
    }

    // --------------------------------------------------------------------
    // Public Content Rules (Managed by Roles)
    // --------------------------------------------------------------------
    
    /**
     * @description Exam Type definitions. Publicly readable for marketing and onboarding pages.
     *              Manageable only by admins.
     * @path        /exam_types/{examTypeId}
     */
    match /exam_types/{examTypeId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }
    
    /**
     * @description Class definitions. Readable by anyone signed in, manageable by admins.
     * @path        /classes/{classId}
     */
    match /classes/{classId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isAdmin();
    }

    /**
     * @description Learning content. Readable by any signed-in user, manageable by teachers or admins.
     * @path        /content/{contentId}
     */
    match /content/{contentId} {
      allow get, list: if isSignedIn()
                        && (!isTeacher()
                            || isAdmin()
                            || (resource != null && resource.data.teacherId == request.auth.uid));
      allow create: if (isTeacher() || isAdmin()) && request.resource.data.teacherId == request.auth.uid;
      allow update, delete: if isAdmin()
                            || (isTeacher()
                                && resource != null
                                && ((('teacherId' in resource.data)
                                      && resource.data.teacherId == request.auth.uid
                                      && request.resource.data.teacherId == resource.data.teacherId)
                                    || (!('teacherId' in resource.data)
                                        && request.resource.data.teacherId == request.auth.uid)));
    }

    /**
     * @description Paid courses. Readable by any signed-in user.
     *              Teachers can manage only their own courses. Admins can manage all courses.
     * @path        /courses/{courseId}
     */
    match /courses/{courseId} {
      allow get, list: if isSignedIn()
                        && (
                          isTeacher()
                          || isAdmin()
                          || (resource != null
                              && (resource.data.accessLevel != 'paid'
                                  || (('subscriptionAttached' in resource.data)
                                      && resource.data.subscriptionAttached == true)))
                        );
      allow create: if (isTeacher() || isAdmin()) && request.resource.data.teacherId == request.auth.uid;
      allow update, delete: if isAdmin()
                            || (isTeacher()
                                && resource != null
                                && ((('teacherId' in resource.data)
                                      && resource.data.teacherId == request.auth.uid
                                      && request.resource.data.teacherId == resource.data.teacherId)
                                    || (!('teacherId' in resource.data)
                                        && request.resource.data.teacherId == request.auth.uid)));
    }

    /**
     * @description Curriculum topics. Readable by anyone signed in.
     *              Teachers/Admins can create topics from question-bank flows.
     *              Updates/deletes remain admin-only to prevent accidental global edits.
     * @path        /topics/{topicId}
     */
    match /topics/{topicId} {
      allow get, list: if isSignedIn();
      allow create: if (isTeacher() || isAdmin())
                    && request.resource.data.name is string
                    && request.resource.data.name.size() > 0
                    && request.resource.data.subjectId is string
                    && request.resource.data.subjectId.size() > 0;
      allow update, delete: if isAdmin();
    }
    
    /**
     * @description Subject definitions. Readable by anyone signed in, manageable by admins.
     * @path        /subjects/{subjectId}
     */
    match /subjects/{subjectId} {
        allow get, list: if isSignedIn();
        allow create, update, delete: if isAdmin();
    }

    /**
     * @description Teacher requests for missing exam/curriculum/subject combinations.
     *              Teachers can submit their own requests; admins can review and manage status.
     * @path        /curriculum_requests/{requestId}
     */
    match /curriculum_requests/{requestId} {
      allow get: if isSignedIn()
                 && (
                   isAdmin()
                   || (resource != null && resource.data.teacherId == request.auth.uid)
                 );
      allow list: if isAdmin()
                  || (
                    isSignedIn()
                    && resource != null
                    && resource.data.teacherId == request.auth.uid
                  );
      allow create: if isSignedIn()
                    && request.resource.data.teacherId == request.auth.uid
                    && request.resource.data.requestedExamType is string
                    && request.resource.data.requestedExamType.size() > 0
                    && request.resource.data.requestedCurriculum is string
                    && request.resource.data.requestedCurriculum.size() > 0
                    && request.resource.data.requestedSubjects is string
                    && request.resource.data.requestedSubjects.size() > 0
                    && request.resource.data.status == 'pending';
      allow update: if isAdmin()
                    && request.resource.data.status in ['pending', 'approved', 'rejected']
                    && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'reviewedAt', 'reviewedBy', 'adminNote']);
      allow delete: if (
                      isAdmin()
                      && resource != null
                      && resource.data.status in ['approved', 'rejected']
                    )
                    || (
                      isSignedIn()
                      && resource != null
                      && resource.data.teacherId == request.auth.uid
                    );
    }

    /**
     * @description Practice questions. Readable by any signed-in user, manageable by teachers.
     * @path        /practice_questions/{practiceQuestionId}
     */
    match /practice_questions/{practiceQuestionId} {
      allow get, list: if isSignedIn();
      allow create: if (isTeacher() || isAdmin())
                    && request.resource.data.teacherId == request.auth.uid;
      allow update: if isAdmin()
                    || (isTeacher()
                        && resource != null
                        && resource.data.teacherId == request.auth.uid
                        && request.resource.data.teacherId == resource.data.teacherId);
      allow delete: if isAdmin()
                    || (isTeacher()
                        && resource != null
                        && resource.data.teacherId == request.auth.uid);
    }

    /**
     * @description Mock tests. Readable by anyone signed in, manageable by teachers or admins.
     * @path        /mock_tests/{mockTestId}
     */
    match /mock_tests/{mockTestId} {
      allow get, list: if isSignedIn()
                        && (
                          isAdmin()
                          || (resource != null && resource.data.teacherId == request.auth.uid)
                          || (resource != null
                              && (!('publicationStatus' in resource.data)
                                  || resource.data.publicationStatus != 'draft'))
                        );
      allow create: if (isTeacher() || isAdmin())
                    && request.resource.data.teacherId == request.auth.uid;
      allow update, delete: if isAdmin()
                            || (isTeacher()
                                && resource != null
                                && resource.data.teacherId == request.auth.uid
                                && request.resource.data.teacherId == resource.data.teacherId);
    }

    /**
     * @description Teacher-owned question banks. Each teacher can organize questions
     *              by exam/curriculum/subjects and reuse them while creating tests.
     * @path        /teacher_question_banks/{bankId}
     */
    match /teacher_question_banks/{bankId} {
      allow get, list: if isSignedIn();
      allow create: if (isTeacher() || isAdmin())
                    && request.resource.data.teacherId == request.auth.uid;
      allow update, delete: if isAdmin()
                            || (isTeacher()
                                && resource != null
                                && resource.data.teacherId == request.auth.uid
                                && request.resource.data.teacherId == resource.data.teacherId);
    }

    // --------------------------------------------------------------------
    // Interactive Content Rules (Mixed Ownership)
    // --------------------------------------------------------------------

    /**
     * @description Live classes scheduled by teachers. Anyone can view the schedule.
     *              Only the teacher who created the class can manage it.
     * @path        /live_classes/{liveClassId}
     */
    match /live_classes/{liveClassId} {
      allow get, list: if isSignedIn();
      allow create: if isTeacher() && request.resource.data.teacherId == request.auth.uid;
      allow update: if resource != null && isOwner(resource.data.teacherId) && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['recordingUrl', 'title', 'startTime', 'duration', 'meetingUrl', 'accessLevel']);
      allow delete: if resource != null && isOwner(resource.data.teacherId);
    }

    /**
     * @description Teacher-created live batches grouped by exam/class/subject.
     * @path        /live_batches/{batchId}
     */
    match /live_batches/{batchId} {
      allow get, list: if isSignedIn();
      allow create: if (isTeacher() || isAdmin())
                    && request.resource.data.teacherId == request.auth.uid;
      allow update, delete: if isAdmin()
                            || (resource != null
                                && isTeacher()
                                && resource.data.teacherId == request.auth.uid
                                && request.resource.data.teacherId == resource.data.teacherId);
    }

    /**
     * @description Daily schedule entries for each live batch (Zoom details + previous recording link).
     * @path        /live_batch_sessions/{sessionId}
     */
    match /live_batch_sessions/{sessionId} {
      allow get, list: if isSignedIn();
      allow create: if (isTeacher() || isAdmin())
                    && request.resource.data.teacherId == request.auth.uid
                    && exists(/databases/$(database)/documents/live_batches/$(request.resource.data.batchId))
                    && get(/databases/$(database)/documents/live_batches/$(request.resource.data.batchId)).data.teacherId == request.auth.uid;
      allow update, delete: if isAdmin()
                            || (resource != null
                                && isTeacher()
                                && resource.data.teacherId == request.auth.uid
                                && request.resource.data.teacherId == resource.data.teacherId);
    }
    
    // --------------------------------------------------------------------
    // Doubt Resolution Rules
    // --------------------------------------------------------------------
    /**
     * @description Manages student doubts. Students create, teachers answer.
     * @path        /doubts/{doubtId}
     */
    match /doubts/{doubtId} {
      allow read, list: if isSignedIn();
      allow create: if isSignedIn()
                    && request.resource.data.studentId == request.auth.uid
                    && ('teacherId' in request.resource.data)
                    && (
                      exists(/databases/$(database)/documents/roles_teacher/$(request.resource.data.teacherId))
                      || exists(/databases/$(database)/documents/roles_admin/$(request.resource.data.teacherId))
                    );
      allow update: if resource != null
                    && (
                      isOwner(resource.data.studentId)
                      || isAdmin()
                      || (isTeacher() && resource.data.teacherId == request.auth.uid)
                    );
      allow delete: if resource != null && isOwner(resource.data.studentId);
    }
    
    // --------------------------------------------------------------------
    // Chat Rules
    // --------------------------------------------------------------------
    /**
     * @description Public group chat messages.
     * @path        /group_chat_messages/{messageId}
     */
    match /group_chat_messages/{messageId} {
      allow read, list: if isSignedIn()
                        && (!isTeacher() || isAdmin());
      allow create: if isSignedIn()
                    && (!isTeacher() || isAdmin())
                    && request.resource.data.senderId == request.auth.uid;
      allow update: if isOwner(resource.data.senderId)
                    && (!isTeacher() || isAdmin())
                    && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['imageUrl', 'isUploading', 'uploadError', 'fileUrl', 'fileName', 'fileType']);
      allow delete: if false;
    }

    /**
     * @description Community announcements for teachers. Admin posts, teachers/admins read.
     * @path        /community_announcements/{messageId}
     */
    match /community_announcements/{messageId} {
      allow get, list: if isSignedIn() && (isTeacher() || isAdmin());
      allow create: if isAdmin()
                    && request.resource.data.senderId == request.auth.uid;
      allow update: if isAdmin()
                    && isOwner(resource.data.senderId)
                    && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['imageUrl', 'isUploading', 'uploadError', 'fileUrl', 'fileName', 'fileType']);
      allow delete: if false;
    }

    /**
     * @description Private 1-on-1 chat messages.
     * @path        /direct_messages/{chatId}/messages/{messageId}
     */
    match /direct_messages/{chatId}/messages/{messageId} {
      allow list, get: if isSignedIn() && request.auth.uid in chatId.split('_');
      allow create: if isSignedIn()
                    && request.auth.uid in chatId.split('_')
                    && request.resource.data.senderId == request.auth.uid
                    && (!isTeacher() || isAdmin() || isTeacherMessagingAdmin(chatId));
      allow update: if isOwner(resource.data.senderId) && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['imageUrl', 'isUploading', 'uploadError', 'fileUrl', 'fileName', 'fileType']);
      allow delete: if false;
    }

    /**
     * @description Direct message thread metadata (last message + unread counts).
     * @path        /direct_message_threads/{chatId}
     */
    match /direct_message_threads/{chatId} {
      allow get, list: if (isSignedIn() && request.auth.uid in resource.data.participants) || isAdmin();
      allow create: if isSignedIn()
                    && request.auth.uid in request.resource.data.participants
                    && request.resource.data.participants.size() == 2
                    && (!isTeacher() || isAdmin() || isTeacherMessagingAdmin(chatId));
      allow update: if isSignedIn()
                    && request.auth.uid in resource.data.participants
                    && request.resource.data.participants == resource.data.participants
                    && (!isTeacher() || isAdmin() || isTeacherMessagingAdmin(chatId));
      allow delete: if false;
    }

    // --------------------------------------------------------------------
    // Subscription & Billing Rules
    // --------------------------------------------------------------------
    
    /**
     * @description Defines the available subscription plans. Readable by all, writable only by admins.
     * @path        /subscription_plans/{planId}
     */
    match /subscription_plans/{planId} {
        allow get, list: if isSignedIn();
        allow create: if isAdmin()
                      || (isTeacher()
                          && request.resource.data.createdByTeacherId == request.auth.uid
                          && (
                            (request.resource.data.linkedContentType == 'course'
                             && request.resource.data.linkedContentId is string
                             && exists(/databases/$(database)/documents/courses/$(request.resource.data.linkedContentId))
                             && get(/databases/$(database)/documents/courses/$(request.resource.data.linkedContentId)).data.teacherId == request.auth.uid
                             && get(/databases/$(database)/documents/courses/$(request.resource.data.linkedContentId)).data.accessLevel == 'paid')
                            ||
                            (request.resource.data.linkedContentType == 'mock_test'
                             && request.resource.data.linkedContentId is string
                             && exists(/databases/$(database)/documents/mock_tests/$(request.resource.data.linkedContentId))
                             && get(/databases/$(database)/documents/mock_tests/$(request.resource.data.linkedContentId)).data.teacherId == request.auth.uid
                             && get(/databases/$(database)/documents/mock_tests/$(request.resource.data.linkedContentId)).data.accessLevel == 'paid')
                            ||
                            (request.resource.data.linkedContentType == 'live_batch'
                             && request.resource.data.linkedContentId is string
                             && exists(/databases/$(database)/documents/live_batches/$(request.resource.data.linkedContentId))
                             && get(/databases/$(database)/documents/live_batches/$(request.resource.data.linkedContentId)).data.teacherId == request.auth.uid
                             && get(/databases/$(database)/documents/live_batches/$(request.resource.data.linkedContentId)).data.accessLevel == 'paid')
                          ));
        allow update: if isAdmin()
                      || (isTeacher()
                          && resource != null
                          && resource.data.createdByTeacherId == request.auth.uid
                          && request.resource.data.createdByTeacherId == resource.data.createdByTeacherId);
        allow delete: if isAdmin()
                      || (isTeacher()
                          && resource != null
                          && resource.data.createdByTeacherId == request.auth.uid);
    }

    /**
     * @description Payment ledger entries for completed purchases.
     * @path        /payments/{paymentId}
     */
    match /payments/{paymentId} {
      allow get: if isSignedIn()
                 && (
                   isAdmin()
                   || (resource != null && resource.data.userId == request.auth.uid)
                   || (resource != null && resource.data.teacherId == request.auth.uid)
                 );
      allow list: if isAdmin();
      allow create: if isSignedIn()
                    && request.resource.data.userId == request.auth.uid
                    && request.resource.data.status == 'paid';
      allow update, delete: if false;
    }

    /**
     * @description Wallet balances for teacher/admin revenue.
     * @path        /wallets/{walletId}
     */
    match /wallets/{walletId} {
      allow get: if isSignedIn()
                 && (
                   isAdmin()
                   || walletId == ('teacher_' + request.auth.uid)
                   || (resource != null && resource.data.ownerId == request.auth.uid)
                 );
      allow list: if isAdmin();
      // NOTE: Temporary client allowance for checkout split credits.
      // Move this to server-side (Razorpay webhook / trusted backend) for production hardening.
      allow create: if isSignedIn()
                    || isAdmin()
                    || (
                      isSignedIn()
                      && request.resource.data.ownerType == 'teacher'
                      && request.resource.data.ownerId == request.auth.uid
                      && walletId == ('teacher_' + request.auth.uid)
                    );
      allow update: if isAdmin()
                    || isSignedIn()
                    || (
                      isSignedIn()
                      && resource != null
                      && resource.data.ownerType == 'teacher'
                      && resource.data.ownerId == request.auth.uid
                      && request.resource.data.ownerType == resource.data.ownerType
                      && request.resource.data.ownerId == resource.data.ownerId
                      && request.resource.data.totalEarned == resource.data.totalEarned
                      && request.resource.data.totalWithdrawn == resource.data.totalWithdrawn
                      && request.resource.data.availableBalance is number
                      && request.resource.data.pendingBalance is number
                      && request.resource.data.availableBalance <= resource.data.availableBalance
                      && request.resource.data.pendingBalance >= resource.data.pendingBalance
                      && request.resource.data.availableBalance + request.resource.data.pendingBalance
                         == resource.data.availableBalance + resource.data.pendingBalance
                    );
      allow delete: if false;
    }

    /**
     * @description Revenue split transaction entries from successful payments.
     * @path        /wallet_transactions/{txId}
     */
    match /wallet_transactions/{txId} {
      allow get: if isSignedIn()
                 && (
                   isAdmin()
                   || (resource != null && resource.data.teacherId == request.auth.uid)
                   || (resource != null && resource.data.userId == request.auth.uid)
                 );
      allow list: if isAdmin();
      allow create: if isSignedIn()
                    && request.resource.data.userId == request.auth.uid;
      allow update, delete: if false;
    }

    /**
     * @description Payout/withdrawal requests for teachers/admin.
     * @path        /payout_requests/{requestId}
     */
    match /payout_requests/{requestId} {
      allow get: if isSignedIn()
                 && (
                   isAdmin()
                   || (resource != null && resource.data.requesterId == request.auth.uid)
                 );
      allow list: if isAdmin()
                  || (
                    isSignedIn()
                    && resource != null
                    && resource.data.requesterId == request.auth.uid
                  );
      allow create: if isSignedIn()
                    && request.resource.data.requesterId == request.auth.uid
                    && request.resource.data.status == 'pending'
                    && (
                      (request.resource.data.requesterType == 'teacher' && isTeacher())
                      || (request.resource.data.requesterType == 'admin' && isAdmin())
                    );
      allow update: if isAdmin();
      allow delete: if false;
    }
    
    // --------------------------------------------------------------------
    // Notification Rules
    // --------------------------------------------------------------------
    /**
     * @description Global notifications. Readable by all, writable only by teachers/admins.
     * @path        /notifications/{notificationId}
     */
    match /notifications/{notificationId} {
      allow read, list: if isSignedIn();
      allow create: if isTeacher() || isAdmin();
      allow update: if false;
      allow delete: if isAdmin()
                    || (
                      isSignedIn()
                      && resource != null
                      && ('recipientId' in resource.data)
                      && resource.data.recipientId == request.auth.uid
                    );
    }

    // --------------------------------------------------------------------
    // Analytics Rules
    // --------------------------------------------------------------------
    /**
     * @description Aggregated analytics for mock tests.
     * @path        /test_analytics/{testId}
     */
    match /test_analytics/{testId} {
      allow read: if isSignedIn();
      allow write: if isSignedIn();
    }

    // --------------------------------------------------------------------
    // Dashboard Configuration Rules
    // --------------------------------------------------------------------
    /**
     * @description Stores dashboard quick links. Manageable by teachers/admins.
     * @path        /dashboard_links/{linkId}
     */
    match /dashboard_links/{linkId} {
      allow read: if isSignedIn();
      allow create, update, delete: if isTeacher() || isAdmin();
    }
  }
}
